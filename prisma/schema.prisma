generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  email             String         @unique
  name              String?
  password          String
  role              String         @default("user")
  preferredLanguage String         @default("en")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  emailVerified     DateTime?      // Added for auth
  image             String?        // Added for user profile
  contributions     CoveragePoint[]
  measurements      Measurement[]
  progress          UserProgress?
  leaderboard       LeaderboardEntry[]
  rankHistory       RankHistory[]
  errorLogs         ErrorLog[]
  performanceLogs   PerformanceLog[]
}

model CoveragePoint {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  location       Json      // { lat: number, lng: number }
  signalStrength Float
  provider       String
  type           String    // 'cellular' or 'wifi'
  technology     String    // '2G', '3G', '4G', '5G'
  reliability    Float
  timestamp      DateTime  @default(now())
  userId         String?   @db.ObjectId
  user           User?     @relation(fields: [userId], references: [id])
  history        CoverageHistory[]
  verifications  Int       @default(0)
  lastVerified   DateTime  @default(now())
  predictedArea  Json?     // Polygon of predicted coverage area
  metadata       Json?     // Additional metadata for coverage point

  @@unique([provider, type, location], name: "provider_type_location_unique")
}

model CoverageHistory {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  coveragePointId String        @db.ObjectId
  coveragePoint   CoveragePoint @relation(fields: [coveragePointId], references: [id])
  signalStrength  Float
  timestamp       DateTime      @default(now())
  userId          String?       @db.ObjectId
  metadata        Json?         // Weather conditions, time of day, etc.
}

model WifiHotspot {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  location     Json
  provider     String
  speed        String?
  isPublic     Boolean  @default(true)
  lastVerified DateTime @default(now())
}

model Measurement {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String   // 'speed', 'signal', or 'latency'
  value     Float
  unit      String
  location  Json
  timestamp DateTime @default(now())
  device    Json
  metadata  Json?    // Additional measurement metadata
  user      User     @relation(fields: [userId], references: [id])
}

model CoverageComparison {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  location    Json     // { lat: number, lng: number }
  providers   Json[]   // Array of provider comparisons
  timestamp   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Gamification Models
model UserProgress {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @unique @db.ObjectId
  user            User      @relation(fields: [userId], references: [id])
  totalPoints     Int       @default(0)
  level           Int       @default(1)
  currentXP       Int       @default(0)
  totalXP         Int       @default(0)
  nextLevelXP     Int       @default(100)
  streak          Int       @default(0)
  lastActive      DateTime  @default(now())
  achievements    UserAchievement[]
  stats          UserStats?
  streaks        UserStreak?
  badges         UserBadge[]
  unlockedAchievements Int @default(0)  // Added to track total unlocked achievements
  lastAchievementAt DateTime?  // Added to track last achievement unlock
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([level])
  @@index([currentXP])
}

model UserStats {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  userProgressId    String    @unique @db.ObjectId
  userProgress      UserProgress @relation(fields: [userProgressId], references: [id])
  totalMeasurements Int       @default(0)
  ruralMeasurements Int       @default(0)
  uniqueLocations   Int       @default(0)
  totalDistance     Float     @default(0)
  contributionScore Float     @default(0)
  verifiedSpots     Int       @default(0)
  helpfulActions    Int       @default(0)
  consecutiveDays   Int       @default(0)
  lastMeasurementDate DateTime?
  qualityScore     Float     @default(0)
  accuracyRate     Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([totalMeasurements])
  @@index([contributionScore])
}

model Achievement {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String    @unique
  description String
  icon        String
  points      Int
  rarity      String    // 'common' | 'rare' | 'epic'
  requirements Json[]   // Array of AchievementRequirement objects
  target      Int?     // Optional target value for progress tracking
  userAchievements UserAchievement[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([rarity])
}

model UserAchievement {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userProgress  UserProgress @relation(fields: [userProgressId], references: [id])
  userProgressId String   @db.ObjectId
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  achievementId String    @db.ObjectId
  progress      Int       @default(0)
  target        Int?      // Optional target value specific to this user
  unlockedAt    DateTime? // When the achievement was unlocked
  notifiedAt    DateTime? // When the user was notified
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userProgressId, achievementId])
  @@index([userProgressId])
  @@index([achievementId])
}

model UserStreak {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userProgress  UserProgress @relation(fields: [userProgressId], references: [id])
  userProgressId String   @unique @db.ObjectId
  currentStreak Int       @default(0)
  lastUpdated   DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model UserBadge {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userProgress  UserProgress @relation(fields: [userProgressId], references: [id])
  userProgressId String   @db.ObjectId
  badgeType     String
  level         Int       @default(1)
  progress      Int       @default(0)
  unlockedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userProgressId, badgeType])
  @@index([userProgressId])
  @@index([badgeType])
}

model LeaderboardEntry {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id])
  points      Int       @default(0)
  rank        Int
  timeframe   String    // daily, weekly, monthly, allTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, timeframe])
  @@index([userId])
  @@index([timeframe])
  @@index([points])
}

model RankHistory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id])
  rank        Int
  date        DateTime  @default(now())
  timeframe   String    // daily, weekly, monthly, allTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, timeframe, date])
  @@index([userId])
  @@index([timeframe])
  @@index([date])
}

model ErrorLog {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?   @db.ObjectId
  user        User?     @relation(fields: [userId], references: [id])
  errorType   String
  message     String
  stack       String?
  metadata    Json?
  severity    String    // info, warning, error, fatal
  timestamp   DateTime  @default(now())
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([errorType])
  @@index([severity])
  @@index([timestamp])
}

model PerformanceLog {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?   @db.ObjectId
  user        User?     @relation(fields: [userId], references: [id])
  operation   String
  duration    Int       // in milliseconds
  success     Boolean   @default(true)
  metadata    Json?
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([operation])
  @@index([timestamp])
  @@index([duration])
}
